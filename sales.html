<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>å£²ä¸Šç®¡ç†</title>
  <?!= include('style.html') ?>
  <?!= include('components/formBuilder.html') ?>
  <?!= include('components/tableBuilder.html') ?>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ˆ å£²ä¸Šç®¡ç†</h1>

    <div id="form-area"></div>
    <hr>
    <h2>ğŸ“‹ ä¸€è¦§</h2>
    <div id="table-area"></div>
  </div>

  <script>
    const CURRENT_SHEET = "TRN_Sales";

    const formConfig = [
      { name: "saleDate", label: "è²©å£²æ—¥", tooltip: "å£²ä¸ŠãŒç™ºç”Ÿã—ãŸæ—¥ä»˜", type: "date", required: true },
      { name: "productCode", label: "å•†å“ã‚³ãƒ¼ãƒ‰", tooltip: "å•†å“ã®è­˜åˆ¥ã‚³ãƒ¼ãƒ‰", required: true },
      { name: "productName", label: "å•†å“å", tooltip: "å•†å“åï¼ˆæ‰‹å…¥åŠ›ï¼‰", required: true },
      { name: "unitPrice", label: "å˜ä¾¡ï¼ˆå††ï¼‰", tooltip: "1å€‹ã‚ãŸã‚Šã®ä¾¡æ ¼", type: "number", required: true },
      { name: "quantity", label: "æ•°é‡", tooltip: "è³¼å…¥å€‹æ•°", type: "number", required: true },
      { name: "total", label: "åˆè¨ˆé‡‘é¡", tooltip: "å˜ä¾¡ Ã— æ•°é‡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰", type: "number", readonly: true },
      { name: "paymentMethod", label: "æ”¯æ‰•æ–¹æ³•", tooltip: "æ”¯æ‰•æ‰‹æ®µã‚’é¸æŠ", type: "select", options: ["ç¾é‡‘", "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ", "é›»å­ãƒãƒãƒ¼"], required: true },
      { name: "note", label: "å‚™è€ƒ", tooltip: "ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°", type: "textarea" }
    ];

    function render() {
      const form = buildForm(formConfig, "render");
      document.getElementById("form-area").innerHTML = "";
      document.getElementById("form-area").appendChild(form);

      google.script.run.withSuccessHandler(data => {
        const table = buildTable(
          formConfig.map(f => f.label),
          data,
          "render"
        );
        document.getElementById("table-area").innerHTML = "";
        document.getElementById("table-area").appendChild(table);
      }).getGenericData(CURRENT_SHEET);

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆè¨ˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
      setTimeout(() => {
        const priceInput = document.querySelector('input[name="unitPrice"]');
        const qtyInput = document.querySelector('input[name="quantity"]');
        const totalInput = document.querySelector('input[name="total"]');

        const calc = () => {
          const unit = parseFloat(priceInput.value) || 0;
          const qty = parseFloat(qtyInput.value) || 0;
          totalInput.value = unit * qty;
        };

        priceInput.addEventListener("input", calc);
        qtyInput.addEventListener("input", calc);
      }, 300);
    }

    window.onload = render;
  </script>
</body>
</html>
<?!= include('gpt-helper.html') ?>
<script>
  function handleError(error) {
    const context = "[Client]";
    const msg = error && error.message ? error.message : "âŒ æœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
    console.error(`${context} âŒ ${msg}`);
    alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n" + msg);
  }
</script>
google.script.run
  .withFailureHandler(handleError)
  .submitGenericForm(data, "MST_Staff");
